--
-- Libraries
--

local http = require "http"
local shortport = require "shortport"
local stdnse = require "stdnse"
local vulns = require "vulns"

--
--  Description
--
description = [[
Sensitive information access in web interface for Cisco RV320 and RV325 routers (CVE-2019-1653)

The presence of the vulnerability is determined with the following:
    - Making a HTTP GET request to /cgi-bin/config.exp
    - The response is checked to see if it includes the text: "####sysconfig####"

This script is not intrusive because:
    - It only performs a simple GET request to the web server.
    - No data or payload is included with the request just the URI.

This check may have False Positives if:
    - The site has a file at /cgi-bin/config.exp which includes the text: "####sysconfig####"

This check may have False negatives if:
    - The exposed config file has been modified to not start with "####sysconfig####"

How to use:
    nmap --script ./cve-2019-1653.nse [target]

References:
* https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20190123-rv-info
* https://seclists.org/fulldisclosure/2019/Mar/59
* https://seclists.org/fulldisclosure/2019/Mar/60
]]

--
-- Author
--
author = "S3ntinelX"

--
-- License
--
license = "Same as Nmap--See https://nmap.org/book/man-legal.html"

--
-- Categories
--
categories = {"safe", "vuln"}

--
-- Port Rule
--
portrule = shortport.http

action = function(host, port)
    local vuln = {
        title = "Sensitive information access in web interface for Cisco RV320 and RV325 routers.",
        IDS = {CVE = "CVE-2019-1653"},
        risk_factor = "High",
        scores = {
            CVSSv3 = "7.5 (HIGH) (AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N)",
        },
        description = [[
A vulnerability in the web-based management interface of Cisco Small Business RV320 and RV325 Dual Gigabit WAN VPN Routers could allow an unauthenticated, 
remote attacker to retrieve sensitive information. 
The vulnerability is due to improper access controls for URLs. 
An attacker could exploit this vulnerability by connecting to an affected device via HTTP or HTTPS and requesting specific URLs. 
A successful exploit could allow the attacker to download the router configuration or detailed diagnostic information. 
Cisco has released firmware updates that address this vulnerability.
        ]],
        references = {
            "https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20190123-rv-info",
            "https://seclists.org/fulldisclosure/2019/Mar/59",
            "https://seclists.org/fulldisclosure/2019/Mar/60",
        },
        dates = {
            disclosure = {year = "2019", month = "3", day = "27"},
        },
    }

    -- Try and access page on the site
    response = http.get(host, port, "/cgi-bin/config.exp")
    if not (response and response.status) then
        stdnse.debug1("Could not connect to server")
        return nil
    end

    -- Check if the page contains a sensitive information
    if (response.status == 200 and response.body:find("####sysconfig####")) then
        -- If found output the vuln report
        local report = vulns.Report:new(SCRIPT_NAME, host, port)
        vuln.state = vulns.STATE.LIKELY_VULN
        return report:make_output(vuln)  
    end

    -- If not we have no reason to believe this was a Cisco router
    return nil
end